# Publish the latest vaccination data for a country
name: Tweet latest vaccination data

on:
  schedule:
    # Hourly run the workflow to check for updates
    - cron: "0 * * * *"
  # Manually run the workflow for debugging
  workflow_dispatch:

jobs:
  publish:
    name: Publish tweet
    runs-on: ubuntu-latest

    strategy:
      # Ensure that a tweet for a country is published even if another fails
      fail-fast: false
      matrix:
        # Set of countries that can be updated
        country:
          - Belgium
          - Bulgaria
          - Czechia
          - Denmark
          - Estonia
          - Finland
          - France
          - Germany
          - Hungary
          - Ireland
          - Italy
          - Latvia
          - Lithuania
          - Luxembourg
          - Malta
          - Netherlands
          - Poland
          - Portugal
          - Romania
          - Slovakia
          - Slovenia
          - Spain
          - Sweden

    steps:
      - name: Checkout covid-19-data
        uses: actions/checkout@v2
        with:
          repository: owid/covid-19-data
          path: covid-19-data

      - name: Checkout covid_vaccine_progress_bot
        uses: actions/checkout@v2
        with:
          path: covid_vaccine_progress_bot

      - name: Install Python
        uses: actions/setup-python@v2

      - name: Install requirements
        run: pip install -r ${{ github.workspace }}/covid_vaccine_progress_bot/requirements.txt

      - name: Publish tweet
        env:
          COUNTRY: ${{ matrix.country }}
          SCRIPTS: ${{ github.workspace }}/covid-19-data/scripts/scripts/vaccinations
          PREVIOUS_DATA: ${{ github.workspace }}/covid_vaccine_progress_bot/output/previous.csv
          POPULATION: ${{ github.workspace }}/covid-19-data/scripts/input/un/population_2020.csv
          BOT_API: ${{ secrets.BOT_API }}
          BOT_API_SECRET: ${{ secrets.BOT_API_SECRET }}
          BOT_ACCESS: ${{ secrets.BOT_ACCESS }}
          BOT_ACCESS_SECRET: ${{ secrets.BOT_ACCESS_SECRET }}
        run: bash ${{ github.workspace }}/covid_vaccine_progress_bot/.github/utils/run.bash

      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: previous
          path: output/previous.csv

  commit:
    name: Commit CSV
    runs-on: ubuntu-latest
    needs: [publish]
    strategy:
      # Ensure that a tweet for a country is published even if another fails
      fail-fast: false
    steps:
      - name: Download a single artifact
        uses: actions/download-artifact@v2
        with:
          name: previous
      - name: Commit last update dates
        uses: EndBug/add-and-commit@v7 # You can change this to use a specific version
        with:
          # The arguments for the `git add` command (see the paragraph below for more info)
          add: 'output'
          # The name of the user that will be displayed as the author of the commit
          author_name: blasf1
          # The email of the user that will be displayed as the author of the commit
          author_email: blasgomossa@gmail.com
          # Name of the branch to use, if different from the one that triggered the workflow
          branch: main
          # The local path to the directory where your repository is located. You should use actions/checkout first to set it up
          cwd: '${{ github.workspace }}/covid_vaccine_progress_bot'
          # The message for the commit
          message: 'Update dates of last tweet'
          # Whether to push the commit and, if any, its tags to the repo. It can also be used to set the git push arguments (see the paragraph below for more info)
          push: true
