# Publish the latest vaccination data for a country
name: Tweet latest vaccination data

on:
  schedule:
    # Hourly run the workflow to check for updates
    - cron: "0 * * * *"
  # Manually run the workflow for debugging
  workflow_dispatch:

jobs:
  publish:
    name: Publish tweet
    runs-on: ubuntu-latest

    strategy:
      # Ensure that a tweet for a country is published even if another fails
      fail-fast: false
      matrix:
        # Set of countries that can be updated
        country:
          - Belgium
          - Bulgaria
          - Czechia
          - Denmark
          - Estonia
          - Finland
          - France
          - Germany
          - Hungary
          - Ireland
          - Italy
          - Latvia
          - Lithuania
          - Luxembourg
          - Malta
          - Netherlands
          - Poland
          - Portugal
          - Romania
          - Slovakia
          - Slovenia
          - Spain
          - Sweden

    steps:
      - name: Checkout covid-19-data
        uses: actions/checkout@v2
        with:
          repository: owid/covid-19-data
          path: covid-19-data

      - name: Checkout covid_vaccine_progress_bot
        uses: actions/checkout@v2
        with:
          path: covid_vaccine_progress_bot

      - name: Install Python
        uses: actions/setup-python@v2

      - name: Install requirements
        run: pip install -r ${{ github.workspace }}/covid_vaccine_progress_bot/requirements.txt

      - name: Publish tweet
        env:
          COUNTRY: ${{ matrix.country }}
          SCRIPTS: ${{ github.workspace }}/covid-19-data/scripts/scripts/vaccinations
          OUTPUT: ${{ github.workspace }}/covid_vaccine_progress_bot/output
          POPULATION: ${{ github.workspace }}/covid-19-data/scripts/input/un/population_2020.csv
          BOT_API: ${{ secrets.BOT_API }}
          BOT_API_SECRET: ${{ secrets.BOT_API_SECRET }}
          BOT_ACCESS: ${{ secrets.BOT_ACCESS }}
          BOT_ACCESS_SECRET: ${{ secrets.BOT_ACCESS_SECRET }}
        run: bash ${{ github.workspace }}/covid_vaccine_progress_bot/.github/utils/run.bash

      - name: Store artifacts
        uses: actions/upload-artifact@v2
        with:
          path: ${{ github.workspace }}/covid_vaccine_progress_bot/output/${{ matrix.country }}.csv

  commit:
    name: Commit dates
    runs-on: ubuntu-latest
    needs: publish

    steps:
      - name: Checkout covid_vaccine_progress_bot
        uses: actions/checkout@v1

      - name: Download artifacts
        uses: actions/download-artifact@v2
        with:
          path: output

      - name: Commit latest update dates
        uses: EndBug/add-and-commit@v7
        with:
          add: output
          author_name: blasf1
          author_email: blasgomossa@gmail.com
          branch: main
          cwd: covid_vaccine_progress_bot
          message: "[BOT] Pushing last date when countries information has been updated."
          pull_strategy: --no-rebase
          push: true
